{{ $architecture := or .architecture "arm64" }}
{{ $suite := or .suite "bullseye" }}
{{ $ospack := or .ospack (printf "ospack-%s-%s" $suite $architecture) }}
{{ $osvideopack := or .osvideopack (printf "osvideopack-%s-%s" $suite $architecture) }}
{{ $multi_cam_rkaiq := or .multi_cam_rkaiq "false" }}

architecture: {{ $architecture }}

actions:
  - action: unpack
    description: Unpack ospack
    file: {{ $ospack }}.tar.gz

  - action: run
    description: Apply Radxa APT
    chroot: true
    environment:
      DEB_SUITE: {{$suite}}
    script: scripts/setup-radxa-apt.sh apply {{$suite}}

{{ if eq $multi_cam_rkaiq "false" }}
  - action: apt
    description: Camera packages
    packages:
      - camera-engine-rkaiq
{{ end }}

  - action: apt
    description: libs
    packages:
      - libxml2
      - libpcap0.8
      - libaudit1
      - libnotify4
      - libc6
      - libjson-c-dev
      - libgtest-dev
      - libstdc++6
      - libmraa
      - libjson-c5
      - libgcc-s1

  - action: apt
    description: Libv4l
    packages:
      - dvb-tools=1.20.0-2
      - libdvbv5-0=1.20.0-2
      - libdvbv5-doc=1.20.0-2
      - libv4l2rds0=1.20.0-2
      - libv4l-dev=1.20.0-2
      - qv4l2=1.20.0-2
      - ir-keytable=1.20.0-2
      - libdvbv5-dev=1.20.0-2
      - libv4l-0=1.20.0-2
      - libv4lconvert0=1.20.0-2
      - libv4l-rkmpp=1.4.0-1
      - v4l-utils=1.20.0-2

  - action: apt
    description: Graphics packages
    packages:
      - libmali-valhall-g610-g6p0-x11
      - glmark2-data
      - glmark2-es2-x11
      - libkms1=2.4.104-1
      - libdrm-cursor=1.3.0-1
      - libdrm-cursor-dev=1.3.0-1

  - action: apt
    description: Mpp packages
    packages:
      - librockchip-mpp1
      - librockchip-mpp-dev
      - librockchip-vpu0
      - rockchip-mpp-demos

  - action: apt
    description: Gstreamer
    packages: [
        gir1.2-gst-plugins-bad-1.0=1.18.5-1, gir1.2-gst-plugins-base-1.0=1.18.5-1,
        gir1.2-gstreamer-1.0=1.18.5-1, gstreamer1.0-alsa=1.18.5-1,
        gstreamer1.0-gl=1.18.5-1, gstreamer1.0-gtk3=1.18.5-1,
        gstreamer1.0-opencv=1.18.5-1, gstreamer1.0-plugins-bad-apps=1.18.5-1,
        gstreamer1.0-plugins-bad=1.18.5-1, gstreamer1.0-plugins-base-apps=1.18.5-1,
        gstreamer1.0-plugins-base=1.18.5-1, gstreamer1.0-plugins-good=1.18.5-1,
        gstreamer1.0-pulseaudio=1.18.5-1, gstreamer1.0-qt5=1.18.5-1,
        gstreamer1.0-rockchip1=1.14-4, gstreamer1.0-tools=1.18.5-1,
        gstreamer1.0-wpe=1.18.5-1, gstreamer1.0-x=1.18.5-1,
        libgstreamer-gl1.0-0=1.18.5-1, libgstreamer-opencv1.0-0=1.18.5-1,
        libgstreamer-plugins-bad1.0-0=1.18.5-1, libgstreamer-plugins-bad1.0-dev=1.18.5-1,
        libgstreamer-plugins-base1.0-0=1.18.5-1, libgstreamer-plugins-base1.0-dev=1.18.5-1,
        libgstreamer1.0-0=1.18.5-1, libgstreamer1.0-dev=1.18.5-1, gstreamer1.0-libav=1.18.5-1 ]

  - action: recipe
    description: Install desktop
    recipe: .desktop/xfce4.yaml

  - action: overlay
    description: Add iqfiles
    source: overlay/etc/iqfiles/
    destination: /etc/iqfiles/

  - action: pack
    description: Pack into tarball
    file: {{ $osvideopack }}.tar.gz
